## **‚öñÔ∏è **Installing MetalLB****

---

### **üöÄ **1. Deploy MetalLB****

**Install MetalLB in the cluster:**

```bash
kubectl apply -f https://raw.githubusercontent.com/metallb/metallb/v0.14.8/config/manifests/metallb-native.yaml
```

**Check the status:**
```bash
kubectl -n metallb-system get svc
kubectl -n metallb-system get pods
kubectl api-resources | grep metallb
```

**Expected output:**
```text
NAME                      TYPE        CLUSTER-IP      EXTERNAL-IP   PORT(S)   AGE
metallb-webhook-service   ClusterIP   10.43.159.103   <none>        443/TCP   44h

NAME                          READY   STATUS    RESTARTS   AGE
controller-6dd967fdc7-hl5wj   1/1     Running   0          44h
speaker-f4mn8                 1/1     Running   0          44h
speaker-wfspw                 1/1     Running   0          44h
speaker-zdqqj                 1/1     Running   0          44h

bfdprofiles                                      metallb.io/v1beta1                true         BFDProfile
bgpadvertisements                                metallb.io/v1beta1                true         BGPAdvertisement
bgppeers                                         metallb.io/v1beta2                true         BGPPeer
communities                                      metallb.io/v1beta1                true         Community
ipaddresspools                                   metallb.io/v1beta1                true         IPAddressPool
l2advertisements                                 metallb.io/v1beta1                true         L2Advertisement
servicel2statuses                                metallb.io/v1beta1                true         ServiceL2Status
```

---

### **üõ†Ô∏è **2. Configure MetalLB****

**Create an IP address pool:**

```bash
cat <<EOF > first-pool.yaml
# first-pool.yaml
apiVersion: metallb.io/v1beta1
kind: IPAddressPool
metadata:
  name: first-pool
  namespace: metallb-system
spec:
  addresses:
    - 172.16.100.10-172.16.100.20
EOF
```

**Roll out the configuration:**

```bash
kubectl create -f first-pool.yaml
```

**Create an L2 Advertisement:**
```bash
cat <<EOF > l2advertisement.yaml
# l2advertisement.yaml
apiVersion: metallb.io/v1beta1
kind: L2Advertisement
metadata:
  name: homelab-l2
  namespace: metallb-system
spec:
  ipAddressPools:
    - first-pool
EOF
```

**Roll out the L2 Advertisement:**

```bash
kubectl create -f l2advertisement.yaml
```

**Verify if the MetalLB is working as expected. To test, create a service of type LoadBalancer::**

```bash
cat <<EOF > kuard-k8s-first.yaml
apiVersion: v1
kind: Service
metadata:
  name: kuard-k8s-first
spec:
  type: LoadBalancer
  ports:
    - port: 80
      targetPort: 8080
      protocol: TCP
  selector:
    app: kuard-k8s-first
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: kuard-k8s-first
spec:
  selector:
    matchLabels:
      app: kuard-k8s-first
  replicas: 1
  template:
    metadata:
      labels:
        app: kuard-k8s-first
    spec:
      containers:
        - name: kuard-container
          image: gcr.io/kuar-demo/kuard-amd64:1
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
      nodeSelector:
        kubernetes.io/hostname: master-01.example.com
EOF
```

**Roll out:**

```bash
kubectl create -f kuard-k8s-first.yaml
```

**Check services in default namespace**
```bash
kubectl get svc -n default
```

**Expected output for the service:**

```text
[root@master-01 ~]# k get svc
NAME                        TYPE           CLUSTER-IP      EXTERNAL-IP     PORT(S)                      AGE
kubernetes                  ClusterIP      10.43.0.1       <none>          443/TCP                      47h
kuard-k8s-first             LoadBalancer   10.43.8.169     172.16.100.10   80:31375/TCP,443:30567/TCP   5h46m
```

- **For `kuard-k8s-first` Service, there needs to External IP address assigned automatically by MetalLB.**

- **It shows that MetalLB load balancer is working as expected.**

---